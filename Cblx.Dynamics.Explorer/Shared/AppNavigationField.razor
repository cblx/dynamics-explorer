@using Cblx.Dynamics.Explorer.Models;
@using System.Linq.Expressions;
@using System.Net.Http.Json;
@using System.Text.Json.Nodes;
@using System.Text.Json;
@using System.Net.Http.Headers;
@inject HttpClient HttpClient
<MudAutocomplete Value="Value"
                 T="string"
                 Variant="Variant.Outlined"
                 ValueChanged="ValueChanged"
                 ResetValueOnEmptyText
                 ToStringFunc="@(str => (str != null && _foundItems.ContainsKey(str)) ? _foundItems[str].Text : str)"
                 For="ValueExpression"
                 HelperText="@(Value is null ? "null" : JsonSerializer.Serialize(Value))"
                 SearchFunc="SearchAsync"
                      ShowProgressIndicator>
    <ItemTemplate>
        <MudStack>
            <MudText>
                @if (context == null)
                {
                    <text>null</text>
                }
                else
                {
                    @_foundItems[context].Text
                }
            </MudText>
            <MudText Typo="Typo.caption">
                @context
            </MudText>
        </MudStack>
    </ItemTemplate>
</MudAutocomplete>
@code {
    [Parameter]
    [EditorRequired]
    public required ColumnInfo Column { get; set; }

    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    [Parameter]
    public Expression<Func<string?>> ValueExpression { get; set; } = default!;

    private Dictionary<string, SearchItem> _foundItems = new()
    {
        {"", new SearchItem { Text = "", Value = null }}
    };

    protected override async Task OnParametersSetAsync()
    {
        if (Column.ForeignTable != null && !string.IsNullOrEmpty(Value))
        {
            if (!_foundItems.ContainsKey(Value))
            {
                await SearchAsync(Value);
            }
        }
    }

    private async Task<IEnumerable<string?>> SearchAsync(string text)
    {
        var foreignPkColumn = Column.ForeignTable!.Columns.FirstOrDefault(c => c.IsPrimaryKey);
        var foreignEntityMetadata = await HttpClient.GetFromJsonAsync<JsonObject>($"/api/data/v9.2/EntityDefinitions(LogicalName='{Column.ForeignTable.OriginalName}')?$select=PrimaryNameAttribute");
        var foreignEntityPrimaryNameAttribute = foreignEntityMetadata!["PrimaryNameAttribute"]!.GetValue<string>();
        string filters = "";
        if (!string.IsNullOrEmpty(text))
        {
            if (Guid.TryParse(text, out var guid))
            {
                filters = $"&$filter={foreignPkColumn!.OriginalName} eq '{guid:D}'";
            }
            else
            {
                filters = $"&$filter=contains({foreignEntityPrimaryNameAttribute},'{text}')";
            }
        }
        string select = $"&$select={foreignPkColumn!.OriginalName}";
        select += $",{foreignEntityPrimaryNameAttribute}";
        var response = await HttpClient.GetFromJsonAsync<JsonObject>($"/api/data/v9.2/{Column.ForeignTable!.Endpoint}?$top=100{select}{filters}");
        var jsonItems = response!["value"]!.AsArray();
        var foundIds = new List<string?>(){ null };
        foreach (var item in jsonItems)
        {
            string id = item![foreignPkColumn.OriginalName]!.GetValue<string>();
            foundIds.Add(id);
            string name = item![foreignEntityPrimaryNameAttribute]!.GetValue<string>();
            _foundItems[id] = new SearchItem
                {
                    Text = name,
                    Value = id
                };
        }
        return foundIds.ToArray();
    }

    class SearchItem
    {
        public required string? Value { get; set; }
        public required string Text { get; set; }
    }
}
