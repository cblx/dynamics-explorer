@using System.Text.Json.Nodes
@using Cblx.Dynamics
@using System.Net.Http.Json
@using Cblx.Dynamics.Explorer.Models;
@using Cblx.Dynamics.Explorer.Services.DynamicsServices.ListEntityAttributes;
@inject HttpClient HttpClient
<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressCircular Indeterminate></MudProgressCircular>
        }
        else
        {
            if (!_options.Any())
            {
                <MudAlert>No options for this column</MudAlert>
            }
            else
            {
                <MudList>
                    @foreach (var option in _options)
                    {
                        <MudListItem>@option.Value - @option.Text</MudListItem>
                    }
                </MudList>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => MudDialog.Close()">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _loading = true;
    private List<PicklistOption> _options = new();

    [Parameter]
    public required AttributeDto Attribute { get; set; }

    [Parameter]
    public required string EntityLogicalName { get; set; }

    [CascadingParameter] 
    MudDialogInstance MudDialog { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var url = Attribute.DerivedType switch
            {
                AttributeMetadataDerivedTypes.PicklistAttributeMetadata => $"EntityDefinitions(LogicalName='{EntityLogicalName}')/Attributes(LogicalName='{Attribute.LogicalName}')/Microsoft.Dynamics.CRM.PicklistAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options)",
                AttributeMetadataDerivedTypes.StateAttributeMetadata => $"EntityDefinitions(LogicalName='{EntityLogicalName}')/Attributes/Microsoft.Dynamics.CRM.StateAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options)",
                AttributeMetadataDerivedTypes.StatusAttributeMetadata => $"EntityDefinitions(LogicalName='{EntityLogicalName}')/Attributes/Microsoft.Dynamics.CRM.StatusAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options)",
                AttributeMetadataDerivedTypes.MultiSelectPicklistAttributeMetadata => $"EntityDefinitions(LogicalName='{EntityLogicalName}')/Attributes(LogicalName='{Attribute.LogicalName}')/Microsoft.Dynamics.CRM.MultiSelectPicklistAttributeMetadata?$select=LogicalName&$expand=OptionSet($select=Options)",
                _ => throw new NotImplementedException()
            };

            var options = await HttpClient.GetFromJsonAsync<JsonObject>(url);
            if (options!.ContainsKey("value"))
            {
                options = options["value"]!.AsArray()!.First()!.AsObject();
            }
            var jsonArray = options!["OptionSet"]!["Options"] as JsonArray;
            var picklistOptions = new List<PicklistOption>();
            foreach (var item in jsonArray!)
            {
                picklistOptions.Add(new PicklistOption
                {
                    Text = item!["Label"]!["LocalizedLabels"]![0]!["Label"]!.GetValue<string>(),
                    Value = item["Value"]!.GetValue<int>()
                });
            }
            _options = picklistOptions;
        }
        catch
        {
            // Do nothing
        }
        finally
        {
            _loading = false;
        }
    }
}